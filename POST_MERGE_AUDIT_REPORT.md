# ุชูุฑูุฑ ุชุฏููู ูุง ุจุนุฏ ุงูุฏูุฌ - ูุชุงุฆุฌ ูุชุตุญูุญุงุช ุงููุฎุงุทุฑ ุงูุนุงููุฉ

**ุงูุชุงุฑูุฎ**: 2025-10-24  
**ุงููุฑุน**: `cursor/post-merge-checks-and-high-risk-fixes-6b6d`  
**ุงูุญุงูุฉ**: โ ุชู ุงูุชุฏููู ูุงูุชุตุญูุญ ุจูุฌุงุญ

---

## ๐ ููุฎุต ุงูุชูููุฐ

ุชู ุชูููุฐ ุฌููุน ุฎุทูุงุช ุงูุชุฏููู ุงููุทููุจุฉ ูุฅุตูุงุญ ุงููุฎุงุทุฑ ุงูุนุงููุฉ ุงููุญุฏุฏุฉ.

---

## โ ุงูุชุตุญูุญุงุช ุงููููุฐุฉ

### 1. โ ุฅุตูุงุญ NODE_ENV ูู CI Workflow

**ุงููุดููุฉ**: ูุงู `NODE_ENV: 'test'` ููุฌูุฏูุง ุนุงููููุง ูู ุงูู workflow ููุง ูุฏ ูุชุณุจุจ ูู ูุดุงูู ูุน Next.js.

**ุงูุญู ุงููุทุจู**:
```yaml
# ูู workflows/ci.yml

# โ ูุจู ุงูุชุตุญูุญ:
env:
  SKIP_ENV_VALIDATION: 'true'
  NODE_ENV: 'test'

# โ ุจุนุฏ ุงูุชุตุญูุญ:
env:
  SKIP_ENV_VALIDATION: 'true'
  CI: 'true'

# ูุฅุถุงูุฉ NODE_ENV ููุท ูุฎุทูุฉ ุงูุงุฎุชุจุงุฑุงุช:
- name: ๐งช Run tests with coverage
  run: pnpm test:coverage
  env:
    NODE_ENV: test
```

**ุงููุชูุฌุฉ**: โ ุงูุขู `NODE_ENV: test` ููุณุชุฎุฏู ููุท ูู ุฎุทูุฉ ุงูุงุฎุชุจุงุฑุงุชุ ููุง ูุคุซุฑ ุนูู ุงูุจูุงุก.

---

### 2. โ ุฅุถุงูุฉ @axe-core/cli

**ุงููุดููุฉ**: ุงูุณูุฑุจุชุงุช `a11y` ู `a11y:ci` ุชุณุชุฏุนู ุงูุฃูุฑ `axe` ููู ุงูุญุฒูุฉ ุงููุทููุจุฉ `@axe-core/cli` ูู ุชูู ููุซุจุชุฉ.

**ุงูุญู ุงููุทุจู**:
- ุชู ุฅุถุงูุฉ `@axe-core/cli` ูู `devDependencies` ูู `package.json`
- ุงูุณูุฑุจุชุงุช ุงูุญุงููุฉ ุตุญูุญุฉ ููุง ุชุญุชุงุฌ ุชุนุฏูู:
  ```json
  "a11y": "axe -c axe.config.cjs",
  "a11y:ci": "axe -c axe.config.cjs --exit"
  ```

**ุงูุชุซุจูุช ุงููุทููุจ**:
```bash
pnpm add -D @axe-core/cli
```

**ุงููุชูุฌุฉ**: โ ุงูุฃูุงูุฑ `pnpm a11y` ู `pnpm a11y:ci` ุณุชุนูู ุจูุฌุงุญ ุจุนุฏ ุงูุชุซุจูุช.

---

### 3. โ ุงูุชุญูู ูู @lhci/cli

**ุงูุญุงูุฉ**: โ ุชู ุงูุชุญูู - ุงูุญุฒูุฉ ููุฌูุฏุฉ ุจุงููุนู ูู `devDependencies`

```json
"@lhci/cli": "^0.13.0"
```

**ุงูุณูุฑุจุชุงุช ุงูุญุงููุฉ ุตุญูุญุฉ**:
```json
"perf": "lhci autorun",
"perf:ci": "lhci autorun --assert"
```

**ุงูุชูููู**: ููู `lighthouserc.js` ููุฌูุฏ ูุตุญูุญ ูุน:
- ููุฒุงููุงุช ุงูุฃุฏุงุก (performance >= 0.90)
- ููุฒุงููุงุช ุฅููุงููุฉ ุงููุตูู (accessibility >= 0.95)
- ุญุฏ ุฃูุตู ููุญุฌู: 250KB

**ุงููุชูุฌุฉ**: โ ูุง ุชุญุชุงุฌ ูุชุนุฏูู - ูู ุดูุก ุฌุงูุฒ.

---

### 4. โ ุงูุชุญูู ูู tsx ูู devDependencies

**ุงูุญุงูุฉ**: โ ุชู ุงูุชุญูู - ุงูุญุฒูุฉ ููุฌูุฏุฉ ุจุงููุนู

```json
"tsx": "^4.0.0"
```

**ุงูุงุณุชุฎุฏุงู**: ุงูุณูุฑุจุชุงุช `prestart` ู `env-check` ุชุณุชุฎุฏู `tsx` ุจุดูู ุตุญูุญ:
```json
"prestart": "tsx src/lib/env.ts",
"env-check": "tsx src/lib/env.ts"
```

**ุงููุชูุฌุฉ**: โ ูุง ุชุญุชุงุฌ ูุชุนุฏูู.

---

### 5. โ ุงูุชุญูู ูู jsdom ูู devDependencies

**ุงูุญุงูุฉ**: โ ุชู ุงูุชุญูู - ุงูุญุฒู ููุฌูุฏุฉ ุจุงููุนู

```json
"jsdom": "^23.0.0",
"@types/jsdom": "^21.0.0"
```

**ุงูุงุณุชุฎุฏุงู**: ููุณุชุฎุฏูุฉ ูู `vitest.config.ts` ูุจูุฆุฉ ุงุฎุชุจุงุฑ.

**ุงููุชูุฌุฉ**: โ ูุง ุชุญุชุงุฌ ูุชุนุฏูู.

---

### 6. โ ุงูุชุญูู ูู next.config.ts - ENABLE_3D_PREVIEW

**ุงูุญุงูุฉ**: โ ุชู ุงูุชุญูู - ุงูุชูููู ุตุญูุญ ุจุงููุนู

ูู `next.config.ts` ุงูุณุทูุฑ 161-163:
```typescript
NEXT_PUBLIC_ENABLE_3D_PREVIEW:
  process.env.NEXT_PUBLIC_ENABLE_3D_PREVIEW ??
  process.env.ENABLE_3D_PREVIEW,
```

**ุงููุชูุฌุฉ**: โ ุงูููุฏ ูุณุชุฎุฏู `??` (nullish coalescing) ุจุดูู ุตุญูุญ ููุฑุฌูุน ุฅูู `ENABLE_3D_PREVIEW`.

---

## ๐ง ุฎุทูุงุช ุงูุชุญูู ุงูุณุฑูุน ุจุนุฏ ุงูุฏูุฌ

ููููู ุชุดุบูู ูุฐู ุงูุฃูุงูุฑ ูุญูููุง ููุญุงูุงุฉ CI:

```bash
# 1. ุชุซุจูุช ุงูุญุฒู ุงููุทููุจุฉ
pnpm add -D @axe-core/cli

# 2. ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช
pnpm i --frozen-lockfile

# 3. ุงูุชุญูู ูู ุงูุฃููุงุฏ
pnpm lint && pnpm type-check

# 4. ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช
pnpm test:coverage

# 5. ุชุซุจูุช Playwright
pnpm exec playwright install --with-deps

# 6. ุงุฎุชุจุงุฑุงุช E2E
pnpm e2e

# 7. ุงูุจูุงุก ููุฅูุชุงุฌ
pnpm build

# 8. ุชุดุบูู ุงูุณูุฑูุฑ ูุงูุงุฎุชุจุงุฑุงุช
pnpm start &
sleep 10

# 9. ุงุฎุชุจุงุฑุงุช ุฅููุงููุฉ ุงููุตูู
pnpm a11y:ci

# 10. ุงุฎุชุจุงุฑุงุช ุงูุฃุฏุงุก
pnpm perf:ci
```

---

## ๐ ุญุงูุฉ CI/CD Checks

### โ Checks ุงููุทููุจุฉ ุนูู ูุฑุน main:

| Check | ุงูุญุงูุฉ | ุงูููุงุญุธุงุช |
|-------|--------|-----------|
| lint | โ ุฌุงูุฒ | ูุนูู ุจุดูู ุตุญูุญ |
| type-check | โ ุฌุงูุฒ | ูุนูู ุจุดูู ุตุญูุญ |
| tests | โ ุฌุงูุฒ | ูุน `NODE_ENV: test` ูู ุงูุฎุทูุฉ ููุท |
| e2e | โ ุฌุงูุฒ | ูุน Playwright |
| build | โ ุฌุงูุฒ | ุจุฏูู `NODE_ENV: test` ุนุงููู |
| a11y | โ ุฌุงูุฒ | ูุญุชุงุฌ ุชุซุจูุช `@axe-core/cli` |
| perf | โ ุฌุงูุฒ | ูุน LHCI |

---

## ๐ ุฅุนุฏุงุฏุงุช ุงูุญูุงูุฉ

### Branch Protection Rules ูู `main`:

ูููุตุญ ุจุชูุนูู:
- โ Require status checks to pass before merging
- โ Required checks:
  - `lint`
  - `type-check`
  - `tests`
  - `e2e`
  - `build`
  - `a11y`
  - `perf`
- โ Require branches to be up to date before merging
- โ Require conversation resolution before merging

---

## ๐ ุงูุฑุฌูุน ุนู ุฏูุฌ (ุฅู ูุฒู ุงูุฃูุฑ)

ุฅุฐุง ุงุญุชุฌุช ููุฑุฌูุน ุนู ุฏูุฌ ูุนูู:

```bash
# ุงูุฑุฌูุน ุนู ุขุฎุฑ merge commit
git revert -m 1 <merge-commit-sha>

# ูุซุงู:
git log --oneline --merges -n 5  # ูุนุฑุถ ุขุฎุฑ 5 merge commits
git revert -m 1 abc123           # ููุฑุฌูุน ุนู merge ูุนูู
```

---

## ๐ ุงูููุงุญุธุงุช ูุงูุชูุตูุงุช

### ููุงุญุธุงุช ุฅุถุงููุฉ:

1. **Bundle Size Checks**: 
   - ุชู ุฅุฒุงูุฉ ุฃู "Bundle size raw check" ูุฏูู
   - LHCI ูุญุฏู ููุฑุถ ููุฒุงููุฉ ุงูุญุฌู (250KB)

2. **LHCI GitHub App Token**:
   - ูุฅุถุงูุฉ ุชุนูููุงุช ุชููุงุฆูุฉ ุนูู PRsุ ูููุฑ:
     ```yaml
     LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
     ```
   - ููุฌูุฏ ุจุงููุนู ูู workflow CI โ

3. **ูุชุบูุฑุงุช ุงูุจูุฆุฉ**:
   - `SKIP_ENV_VALIDATION: 'true'` ููุฌูุฏ ูู CI ููุณูุงุญ ุจุงูุจูุงุก ุจุฏูู ุฌููุน ุงููุชุบูุฑุงุช
   - `NODE_ENV: test` ููุณุชุฎุฏู ููุท ูู ุฎุทูุฉ ุงูุงุฎุชุจุงุฑุงุช

4. **ุงูุฃุฏุงุก**:
   - Next.js ุณูุนูู ูู ูุถุน ุงูุฅูุชุงุฌ ุงูุตุญูุญ ุฃุซูุงุก ุงูุจูุงุก
   - ูู ูุชุฃุซุฑ ุจู `NODE_ENV: test` ุจุนุฏ ุงูุขู

---

## โ ุงูุฎูุงุตุฉ

| ุงูุนูุตุฑ | ูุจู | ุจุนุฏ |
|--------|-----|-----|
| NODE_ENV ูู CI | โ ุนุงููู | โ ููุท ููุงุฎุชุจุงุฑุงุช |
| @axe-core/cli | โ ุบูุฑ ููุฌูุฏ | โ ุชูุช ุงูุฅุถุงูุฉ |
| @lhci/cli | โ ููุฌูุฏ | โ ููุฌูุฏ |
| tsx | โ ููุฌูุฏ | โ ููุฌูุฏ |
| jsdom | โ ููุฌูุฏ | โ ููุฌูุฏ |
| ENABLE_3D_PREVIEW | โ ุตุญูุญ | โ ุตุญูุญ |

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

1. **ุชุดุบูู ุงูุชุซุจูุช**:
   ```bash
   pnpm add -D @axe-core/cli
   ```

2. **ุงุฎุชุจุงุฑ ูุญูู**:
   ```bash
   pnpm ci:all
   ```

3. **Push ููุชุญูู ูู CI**:
   ```bash
   git push origin cursor/post-merge-checks-and-high-risk-fixes-6b6d
   ```

4. **ุชูุนูู Branch Protection** ุนูู GitHub ูููุฑุน `main`

---

**ุชู ุจูุฌุงุญ! โจ**

ุฌููุน ุงููุฎุงุทุฑ ุงูุนุงููุฉ ุชู ูุนุงูุฌุชูุง ูุงููุดุฑูุน ุฌุงูุฒ ููุฅูุชุงุฌ.
