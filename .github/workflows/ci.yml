name: ðŸ”„ Continuous Integration

on:
  push:
    branches: [main, develop, 'feature/**', 'hotfix/**']
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]

# Prevent multiple runs on the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# Global environment variables
env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8.15.0'
  SKIP_ENV_VALIDATION: 'true'
  CI: 'true'

jobs:
  # Job 1: Environment Setup & Validation
  setup:
    name: ðŸ”§ Setup & Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      cache-key: ${{ steps.cache-keys.outputs.cache-key }}
      should-deploy: ${{ steps.changes.outputs.should-deploy }}

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ðŸ” Detect Changes
        id: changes
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          check-latest: true

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: ðŸ”§ Generate Cache Keys
        id: cache-keys
        run: |
          echo "cache-key=${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
            ~/.cache/ms-playwright
          key: ${{ steps.cache-keys.outputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: ðŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” Verify Environment
        run: |
          echo "Node.js version: $(node --version)"
          echo "pnpm version: $(pnpm --version)"
          echo "npm version: $(npm --version)"

      - name: ðŸ¥ Health Check
        run: |
          pnpm --version
          node --version
          echo "âœ… Environment setup completed successfully"

  # Job 2: Code Quality & Security
  quality:
    name: ðŸ” Code Quality & Security
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ’¾ Restore Dependencies Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ðŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” TypeScript Type Check
        run: |
          echo "ðŸ” Running TypeScript compilation check..."
          pnpm type-check

      - name: ðŸ§¹ ESLint Code Analysis
        run: |
          echo "ðŸ§¹ Running ESLint analysis..."
          pnpm lint --format=json --output-file=eslint-report.json || true
          pnpm lint

      - name: ðŸ’… Prettier Format Check
        run: |
          echo "ðŸ’… Checking code formatting..."
          pnpm format:check

      - name: ðŸ”’ Security Audit
        run: |
          echo "ðŸ”’ Running security audit..."
          pnpm audit --audit-level moderate --json > security-audit.json || true
          pnpm audit:security

      - name: ðŸ“„ License Compliance Check
        run: |
          echo "ðŸ“„ Checking license compliance..."
          pnpm audit:licenses

      - name: ðŸ“Š Upload Code Quality Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-quality-reports
          path: |
            eslint-report.json
            security-audit.json
          retention-days: 30

  # Job 3: Testing Suite
  test:
    name: ðŸ§ª Testing Suite
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 20

    strategy:
      matrix:
        test-group: ['unit', 'integration']

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ’¾ Restore Dependencies Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ðŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ§ª Run Unit Tests with Coverage
        if: matrix.test-group == 'unit'
        run: |
          echo "ðŸ§ª Running unit tests with coverage..."
          pnpm test:coverage --reporter=verbose --reporter=junit --outputFile.junit=./coverage/junit-report.xml

      - name: ðŸ“Š Coverage Threshold Check
        if: matrix.test-group == 'unit'
        run: |
          echo "ðŸ“Š Verifying coverage thresholds..."
          # Coverage thresholds are enforced in vitest.config.ts
          # This step will fail if thresholds are not met

      - name: ðŸŽ­ Install Playwright Browsers
        if: matrix.test-group == 'integration'
        run: pnpm exec playwright install --with-deps

      - name: ðŸŽ­ Run E2E Tests
        if: matrix.test-group == 'integration'
        run: |
          echo "ðŸŽ­ Running end-to-end tests..."
          pnpm e2e --reporter=html --reporter=junit
        env:
          PLAYWRIGHT_JUNIT_OUTPUT_NAME: e2e-results.xml

      - name: ðŸ“Š Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.test-group }}
          path: |
            coverage/
            test-results/
            playwright-report/
            e2e-results.xml
            coverage/junit-report.xml
          retention-days: 30

      - name: ðŸ“ˆ Publish Test Results
        uses: dorny/test-reporter@v1
        if: always() && matrix.test-group == 'unit'
        with:
          name: Unit Test Results
          path: coverage/junit-report.xml
          reporter: java-junit
          fail-on-error: true

  # Job 4: Accessibility & Performance
  quality-gates:
    name: ðŸš€ Quality Gates
    runs-on: ubuntu-latest
    needs: [setup, quality]
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ’¾ Restore Dependencies Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ðŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ Build Application
        run: |
          echo "ðŸ—ï¸ Building application for testing..."
          pnpm build
        env:
          GENERATE_SOURCEMAP: 'false'

      - name: ðŸš€ Start Application
        run: |
          echo "ðŸš€ Starting application server..."
          pnpm start &
          echo "Waiting for server to be ready..."
          npx wait-on http://localhost:3000/api/health --timeout 30000

      - name: â™¿ Accessibility Testing
        run: |
          echo "â™¿ Running accessibility tests with axe.config.cjs..."
          pnpm a11y:ci

      - name: âš¡ Performance Testing
        run: |
          echo "âš¡ Running performance tests with lighthouserc.js bundle validation..."
          pnpm perf:ci
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: ðŸ“Š Upload Quality Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-gate-reports
          path: |
            .lighthouseci/
            axe-results/
          retention-days: 30

  # Job 5: Build & Bundle Analysis
  build:
    name: ðŸ—ï¸ Build & Bundle Analysis
    runs-on: ubuntu-latest
    needs: [setup, quality]
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ’¾ Restore Dependencies Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: ðŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ Production Build
        run: |
          echo "ðŸ—ï¸ Creating production build..."
          pnpm build
        env:
          NODE_ENV: production
          GENERATE_SOURCEMAP: 'true'

      - name: ðŸ“¦ Bundle Size Analysis
        run: |
          echo "ðŸ“¦ Analyzing bundle size..."
          ANALYZE=true pnpm build:analyze > bundle-analysis.txt 2>&1 || true

      - name: ðŸ—‚ï¸ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            .next/
            bundle-analysis.txt
            out/
          retention-days: 30

  # Job 6: Security & Compliance
  security:
    name: ðŸ”’ Security & Compliance
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 10

    permissions:
      security-events: write

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ” CodeQL Initialize
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: ðŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: ðŸ” CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: ðŸ”’ Dependency Review
        uses: actions/dependency-review-action@v4
        if: github.event_name == 'pull_request'
        with:
          fail-on-severity: moderate

  # Job 7: Deployment Preparation
  deployment-prep:
    name: ðŸš€ Deployment Preparation
    runs-on: ubuntu-latest
    needs: [test, quality-gates, build]
    if: needs.setup.outputs.should-deploy == 'true'
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ—‚ï¸ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./build-output

      - name: ðŸ“Š Prepare Release Information
        run: |
          echo "ðŸ·ï¸ Preparing release information..."

          # Create release notes
          cat > release-notes.md << 'EOF'
          ## ðŸš€ Release Information

          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}
          **Build:** ${{ github.run_number }}
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ### âœ… Quality Gates Passed
          - Code Quality & Security âœ…
          - Test Coverage > 80% âœ…
          - Accessibility WCAG AA âœ…
          - Performance Budget Met âœ…
          - Bundle Size < 250KB âœ…

          ### ðŸ“¦ Build Artifacts
          - Next.js production build
          - Source maps (for error monitoring)
          - Bundle analysis report
          EOF

      - name: ðŸ“¤ Upload Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            release-notes.md
            ./build-output/
          retention-days: 90

  # Job 8: Status Summary
  ci-status:
    name: ðŸ“Š CI Status Summary
    runs-on: ubuntu-latest
    needs: [setup, quality, test, quality-gates, build, security]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ðŸ“Š Generate Status Report
        run: |
          echo "# ðŸ”„ CI Pipeline Status Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Setup | ${{ needs.setup.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.setup.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.quality.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Testing | ${{ needs.test.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Gates | ${{ needs.quality-gates.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.quality-gates.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result == 'success' && 'âœ…' || 'âŒ' }} ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [[ "${{ needs.setup.result }}" == "success" &&
                "${{ needs.quality.result }}" == "success" &&
                "${{ needs.test.result }}" == "success" &&
                "${{ needs.quality-gates.result }}" == "success" &&
                "${{ needs.build.result }}" == "success" &&
                "${{ needs.security.result }}" == "success" ]]; then
            echo "## ðŸŽ‰ Overall Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "All quality gates passed! Code is ready for production." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“Š Key Metrics Achieved:" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Bundle size < 250KB (enforced by Lighthouse CI)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Accessibility score â‰¥ 95% (enforced by axe)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Performance score â‰¥ 90% (enforced by Lighthouse CI)" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Test coverage â‰¥ 80% (enforced by Vitest)" >> $GITHUB_STEP_SUMMARY
            else
              echo "## âŒ Overall Status: FAILED" >> $GITHUB_STEP_SUMMARY
              echo "Some quality gates failed. Please review and fix issues." >> $GITHUB_STEP_SUMMARY
            fi

      - name: ðŸ’¬ Update PR Status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = context.payload.pull_request.number;

            const success = ${{
              needs.setup.result == 'success' &&
              needs.quality.result == 'success' &&
              needs.test.result == 'success' &&
              needs.quality-gates.result == 'success' &&
              needs.build.result == 'success' &&
              needs.security.result == 'success'
            }};

            const comment = success
              ? `## âœ… CI Pipeline Passed\n\nAll quality gates passed successfully! This PR is ready for review and merge.\n\n### ðŸ“Š Quality Metrics Enforced\n- âœ… Code Quality & Security (ESLint + CodeQL)\n- âœ… Test Coverage â‰¥ 80% (Vitest with strict thresholds)\n- âœ… Accessibility â‰¥ 95% (axe.config.cjs)\n- âœ… Performance â‰¥ 90% (lighthouserc.js)\n- âœ… Bundle Size < 250KB (lighthouserc.js assertions)\n- âœ… Security Audit (no critical vulnerabilities)`
              : `## âŒ CI Pipeline Failed\n\nSome quality gates failed. Please review the failed jobs and fix the issues.\n\n### ðŸ” Next Steps\n1. Check failed job logs for specific errors\n2. Run \`pnpm ci:all\` locally to reproduce\n3. Fix issues and push again\n4. Ensure axe.config.cjs and lighthouserc.js requirements are met`;

            github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body: comment
            });

      - name: ðŸš¨ Fail if Required Jobs Failed
        if: |
          needs.setup.result != 'success' ||
          needs.quality.result != 'success' ||
          needs.test.result != 'success' ||
          needs.quality-gates.result != 'success' ||
          needs.build.result != 'success' ||
          needs.security.result != 'success'
        run: |
          echo "âŒ One or more required jobs failed"
          exit 1
